# Журнал изменений проекта Iwanna

**Правило:** Все изменения в проекте должны фиксироваться в этом файле.

**Формат записи:**
```
## [Дата] - Краткое описание

### Изменено:
- Что было изменено
- Почему было изменено
- Какие файлы затронуты

### Коммит:
- Хеш коммита (если применимо)
```

---

## [03.10.2025] - Создание AI-инструкций для разных ассистентов

### Изменено:
- **Созданы инструкции для AI-ассистентов:**
  - `CLAUDE.md` - для Claude Projects/Desktop (7 KB, полные инструкции)
  - `.clinerules` - для Cline (VS Code extension)
  - `.cursorrules` - для Cursor IDE
  - `.github/copilot-instructions.md` - для GitHub Copilot
  - `docs/AI_SETUP.md` - объяснение как это работает
  - `docs/GUIDE.md` - путеводитель по документации

- **Все инструкции содержат:**
  - Ссылки на docs/prd.md (ЕДИНЫЙ ИСТОЧНИК ПРАВДЫ)
  - Ссылки на docs/logs.md и docs/TROUBLESHOOTING.md
  - Обязательные правила работы с проектом
  - Критические проблемы
  - Структуру проекта
  - Примеры типовых задач

- **Обновлен README.md:**
  - Добавлен раздел "Для AI-ассистентов"
  - Ссылки на все инструкции

### Причина:
Пользователь задал правильный вопрос: "Как сделать так чтобы AI автоматически читал правила?"

**Проблема:** Обычный README.md НЕ читается AI автоматически.

**Решение:** Создать специальные файлы которые каждый AI-инструмент читает автоматически:
- Cline читает `.clinerules`
- Cursor читает `.cursorrules`
- Copilot читает `.github/copilot-instructions.md`
- Claude Projects читает `CLAUDE.md` (если добавлен в Project Knowledge)

Теперь любой AI-ассистент, открывший проект, автоматически:
1. Узнает о существовании docs/prd.md
2. Прочитает обязательные правила
3. Проверит известные проблемы
4. Будет обновлять документацию после изменений

### Преимущества:
- ✅ Контекст проекта сохраняется между сессиями
- ✅ Разные AI следуют одним правилам
- ✅ Документация всегда актуальна
- ✅ Не нужно объяснять контекст заново
- ✅ AI не сломает существующую архитектуру

### Файлы:
- `CLAUDE.md` (создан)
- `.clinerules` (создан)
- `.cursorrules` (создан)
- `.github/copilot-instructions.md` (создан)
- `docs/AI_SETUP.md` (создан)
- `docs/GUIDE.md` (создан)
- `README.md` (обновлен)

---

## [03.10.2025] - Реализация функционала админки для вендоров

### Изменено:
- **Добавлен выбор бренда в AdminSpaEdit:**
  - Импортирован хук `useBrands`
  - Добавлено поле `brand_id` в форму
  - Создан Select для выбора бренда в основной информации

- **Создано управление удобствами СПА:**
  - Создан сервис `spaAmenitiesService.ts` для работы с таблицей `spa_amenities`
  - Добавлено поле `custom_description` в таблицу `spa_amenities`
  - Создан хук `useSpaAmenities.ts` для управления удобствами
  - Обновлена вкладка "Удобства" в `AdminSpaEdit`:
    - Добавление удобств из справочника
    - Редактирование кастомных описаний
    - Удаление удобств

- **Ограничена видимость для вендоров:**
  - Добавлен метод `getByVendorBrands` в `spaService`
  - Обновлен хук `useSpas` для фильтрации по роли:
    - Админы видят все СПА
    - Вендоры видят только СПА своих брендов
    - Обычные пользователи не видят админку

- **Создан личный кабинет вендора:**
  - Создан компонент `VendorDashboard.tsx`
  - Добавлен маршрут `/adminko/dashboard` с ограничением для вендоров
  - Добавлена ссылка "Дашборд" в сайдбар админки
  - Дашборд включает:
    - Статистику (количество СПА, заявок)
    - Быстрые действия
    - Список брендов
    - Список СПА комплексов
    - Последние заявки

### Причина:
Реализация требований из PRD для полноценной работы вендоров с платформой.

### Файлы:
- `src/components/AdminSpaEdit.tsx` (обновлен)
- `src/services/spaAmenitiesService.ts` (создан)
- `src/hooks/useSpaAmenities.ts` (создан)
- `src/services/spaService.ts` (обновлен)
- `src/hooks/useSpas.ts` (обновлен)
- `src/components/VendorDashboard.tsx` (создан)
- `src/App.tsx` (обновлен)
- `src/components/layout/sidebar-data.ts` (обновлен)

---

## [03.10.2025] - Создание системы документации

### Изменено:
- **Создана папка `docs/`**
- **Создан `docs/prd.md`** - Product Requirements Document (единый источник правды)
- **Создан `docs/logs.md`** - этот файл, журнал всех изменений
- **Установлено правило:** Все изменения фиксируются здесь

### Причина:
Проект разросся, теряется контроль над изменениями. Нужна централизованная документация для:
- Понимания текущего состояния системы
- Отслеживания изменений
- Передачи проекта другим разработчикам
- Упрощения отладки

### Файлы:
- `docs/prd.md` (создан)
- `docs/logs.md` (создан)

---

## [03.10.2025] - Система брендов и активации вендоров

### Изменено:
- **База данных:**
  - Добавлена таблица `brands` с полями: name, description, logo, owner_id, active
  - Добавлена таблица `spa_amenities` для кастомных описаний удобств
  - Добавлено поле `profiles.active` (BOOLEAN) для активации вендоров
  - Добавлено поле `spas.brand_id` для привязки СПА к брендам
  - Созданы RLS политики для brands и spa_amenities

- **Frontend - Админка:**
  - Создан компонент `AdminBrandsPage.tsx` - управление брендами
  - Обновлен `AdminUsersPage.tsx`:
    - Убрано поле `spa_id`
    - Добавлено поле `active` для вендоров
    - Добавлен переключатель активации вендора
    - Показ статуса "Активен" / "На модерации"
  
- **Frontend - Для бизнеса:**
  - Создан `BusinessPage.tsx` - посадочная для вендоров
  - Создан `BusinessRegisterPage.tsx` - регистрация вендора
  - Создан `BusinessLoginPage.tsx` - вход вендора
  - Создан `BusinessPendingPage.tsx` - страница ожидания модерации

- **Роутинг:**
  - Добавлены маршруты: `/business`, `/business/register`, `/business/login`, `/business/pending`
  - Добавлен маршрут `/adminko/brands`
  - Обновлен `ProtectedRoute` для проверки активности вендоров

- **Сервисы:**
  - Создан `brandService.ts` - CRUD операции для брендов
  - Создан хук `useBrands.ts` - загрузка брендов

- **UI:**
  - Добавлена ссылка "Для бизнеса" в футер
  - Добавлена ссылка "Бренды" в сайдбар админки

### Логика работы:
1. Вендор регистрируется через `/business/register`
2. Создается профиль с `role: 'vendor'` и `active: false`
3. Вендор может войти, но попадает на `/business/pending`
4. Админ активирует вендора в `/adminko/users`
5. Админ привязывает бренд к вендору в `/adminko/brands`
6. Вендор получает доступ к админке `/adminko`

### Миграции:
- `migrations/add-brands-system.sql` - добавление таблиц и полей
- `migrations/fix-active-default.sql` - установка DEFAULT для active

### Файлы:
- `src/components/AdminBrandsPage.tsx` (создан)
- `src/components/AdminUsersPage.tsx` (изменен)
- `src/components/BusinessPage.tsx` (создан)
- `src/components/BusinessRegisterPage.tsx` (создан)
- `src/components/BusinessLoginPage.tsx` (создан)
- `src/components/BusinessPendingPage.tsx` (создан)
- `src/components/ProtectedRoute.tsx` (изменен)
- `src/components/Footer.tsx` (изменен)
- `src/contexts/AuthContext.tsx` (изменен - добавлено поле active)
- `src/services/brandService.ts` (создан)
- `src/hooks/useBrands.ts` (создан)
- `src/App.tsx` (изменен - добавлены роуты)
- `migrations/add-brands-system.sql` (создан)

---

## [03.10.2025] - Оптимизация производительности

### Проблема:
Страницы загружаются более 10 секунд. Запросы к `profiles` зависают.

### Изменено:
- **База данных:**
  - Создана миграция `add-performance-indexes.sql`
  - Добавлены индексы:
    - `profiles(role)`, `profiles(active)`, `profiles(role, active)`
    - `spas(active)`, `spas(brand_id)`, `spas(country_id)`, `spas(city_id)`
    - `brands(owner_id)`, `brands(active)`
    - `leads(spa_id)`, `leads(status)`, `leads(created_at DESC)`
    - `spa_amenities(spa_id)`, `spa_amenities(amenity_id)`
    - `cities(country_id)`

- **AuthContext:**
  - Полностью переписан с оптимизациями:
    - Добавлено кэширование профилей (`profileCache`)
    - Защита от множественных одновременных запросов (`fetchingProfile.current`)
    - Убраны таймауты
    - Добавлен флаг `mounted` для предотвращения memory leaks
    - Удалены избыточные console.log

- **AdminUsersPage:**
  - Добавлен `.limit(100)` в запрос
  - Удалены избыточные console.log
  - Упрощена логика загрузки

### Статус:
🔴 **НЕ РЕШЕНО** - проблема сохраняется, требуется дальнейшая диагностика

### Гипотезы:
1. RLS политики слишком сложные
2. Проблемы с сетью до Supabase
3. Проблемы на стороне Supabase
4. Неоптимальные запросы

### Следующие шаги:
1. Временно отключить RLS для диагностики
2. Проверить медленные запросы в Supabase Dashboard
3. Добавить мониторинг времени запросов
4. Рассмотреть использование реплик для чтения

### Файлы:
- `src/contexts/AuthContext.tsx` (переписан)
- `src/components/AdminUsersPage.tsx` (оптимизирован)
- `migrations/add-performance-indexes.sql` (создан)

---

## [03.10.2025] - Исправление ошибок регистрации

### Проблема:
При регистрации вендора ошибка: `duplicate key value violates unique constraint "profiles_pkey"`

### Изменено:
- **BusinessRegisterPage:**
  - Добавлена проверка существования профиля перед созданием
  - Улучшена обработка ошибок
  - Изменена маска телефона с российской на международную (+1)
  - Добавлены понятные сообщения об ошибках

### Причина ошибки:
Пользователь уже существовал в auth, но профиль не был создан или не удалось создать.

### Файлы:
- `src/components/BusinessRegisterPage.tsx` (изменен)

---

## Шаблон для будущих записей

```markdown
## [ДД.ММ.ГГГГ] - Краткое описание изменения

### Изменено:
- Что конкретно изменилось
- Список затронутых компонентов

### Причина:
Почему было внесено изменение

### Файлы:
- `path/to/file.tsx` (создан/изменен/удален)

### Связанные задачи:
- Ссылки на issues, если применимо
```

---

## Правила ведения журнала

1. **Обязательно** добавлять запись при:
   - Создании/удалении файлов
   - Изменении структуры БД (миграции)
   - Добавлении нового функционала
   - Исправлении критических багов
   - Изменении API или сервисов

2. **Формат даты:** ДД.ММ.ГГГГ

3. **Структура записи:**
   - Дата и краткое описание
   - Раздел "Изменено" с деталями
   - Раздел "Причина" с объяснением
   - Список файлов

4. **Уровни важности:**
   - 🔴 Критично - требует немедленного внимания
   - 🟡 Важно - требует внимания
   - 🟢 Информация - для сведения

5. **Связь с PRD:**
   - После каждого изменения обновлять соответствующий раздел в `prd.md`
   - Особенно важно обновлять раздел "Текущий статус"

---

*Журнал создан: 03.10.2025*
