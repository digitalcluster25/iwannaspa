# Product Requirements Document (PRD)
# Проект: Iwanna - Платформа бронирования СПА

**Версия документа:** 1.0  
**Дата последнего обновления:** 03.10.2025  
**Статус:** В разработке

---

## 📋 Содержание

1. [Обзор проекта](#обзор-проекта)
2. [Архитектура системы](#архитектура-системы)
3. [Роли пользователей](#роли-пользователей)
4. [Функциональные требования](#функциональные-требования)
5. [Структура базы данных](#структура-базы-данных)
6. [API и сервисы](#api-и-сервисы)
7. [Маршруты приложения](#маршруты-приложения)
8. [Текущий статус](#текущий-статус)

---

## 🎯 Обзор проекта

**Iwanna** - веб-платформа для поиска и бронирования СПА комплексов.

### Основные цели:
- Клиенты могут искать и бронировать СПА
- Вендоры могут управлять своими СПА комплексами
- Администраторы контролируют всю систему

### Технологический стек:
- **Frontend:** React 18, TypeScript, Vite
- **Backend:** Supabase (PostgreSQL, Auth, Storage)
- **UI:** shadcn/ui, Tailwind CSS
- **Routing:** React Router v6

---

## 🏗️ Архитектура системы

```
┌─────────────────────────────────────────────────────────┐
│                    FRONTEND (React)                      │
├─────────────────────────────────────────────────────────┤
│  ┌──────────┐  ┌──────────┐  ┌──────────┐              │
│  │  Public  │  │  Vendor  │  │  Admin   │              │
│  │  Pages   │  │  Panel   │  │  Panel   │              │
│  └──────────┘  └──────────┘  └──────────┘              │
└─────────────────────────────────────────────────────────┘
                        ↓ ↑
┌─────────────────────────────────────────────────────────┐
│              SUPABASE (Backend as a Service)            │
├─────────────────────────────────────────────────────────┤
│  ┌──────────┐  ┌──────────┐  ┌──────────┐              │
│  │   Auth   │  │ Database │  │  Storage │              │
│  │          │  │  (Postgres)│ │          │              │
│  └──────────┘  └──────────┘  └──────────┘              │
└─────────────────────────────────────────────────────────┘
```

---

## 👥 Роли пользователей

### 1. **User (Клиент)**
- Просмотр каталога СПА
- Поиск и фильтрация
- Отправка заявок на бронирование
- Просмотр своих заявок

### 2. **Vendor (Вендор)**
- **Статус: активный/неактивный**
- Регистрация через `/business/register`
- Ожидание активации администратором
- После активации:
  - Управление брендом
  - Добавление/редактирование СПА
  - Просмотр заявок
  - Управление удобствами СПА

### 3. **Admin (Администратор)**
- Полный доступ ко всей системе
- Управление пользователями
- Модерация вендоров (активация)
- Управление справочниками
- Привязка брендов к вендорам

---

## ⚙️ Функциональные требования

### Публичная часть

#### Главная страница (`/`)
- Hero секция с поиском
- Популярные СПА
- Категории
- Призыв к действию

#### Каталог (`/catalog`)
- Список всех активных СПА
- Фильтры:
  - По стране
  - По городу
  - По категории
  - По удобствам
  - По цене
- Карточки СПА с фото и базовой информацией

#### Страница СПА (`/spa/:id`)
- Детальная информация
- Галерея фото
- Список удобств с иконками
- Описание
- Форма заявки на бронирование

#### Для бизнеса (`/business`)
- Информация для вендоров
- Преимущества платформы
- Призыв к регистрации

---

### Система брендов и вендоров

#### Регистрация вендора (`/business/register`)
**Поля формы:**
- Имя или название компании (обязательно)
- Email (обязательно)
- Телефон (опционально, международный формат)
- Пароль (минимум 6 символов)
- Подтверждение пароля

**Процесс:**
1. Вендор заполняет форму
2. Создается аккаунт в `auth.users`
3. Создается профиль в `profiles` с:
   - `role: 'vendor'`
   - `active: false` (неактивен до модерации)
4. Показывается сообщение об успешной регистрации
5. Вендор может войти, но попадает на `/business/pending`

#### Вход вендора (`/business/login`)
- Проверка что пользователь - вендор
- Если `active: false` → перенаправление на `/business/pending`
- Если `active: true` → перенаправление в админку `/adminko`

#### Страница модерации (`/business/pending`)
- Информация о статусе модерации
- Ожидание активации
- Контакты поддержки
- Кнопка выхода

---

### Панель администратора

#### СПА комплексы (`/adminko`)
- Список всех СПА
- Создание/редактирование/удаление
- Привязка к бренду
- Управление фото
- Управление удобствами

#### Бренды (`/adminko/brands`)
**Таблица brands:**
- `id` (UUID, PK)
- `name` (TEXT, обязательно)
- `description` (TEXT, опционально)
- `logo` (TEXT, URL)
- `owner_id` (UUID, FK → profiles.id)
- `active` (BOOLEAN, default true)

**Функционал:**
- Создание бренда
- Привязка к вендору (выбор из списка вендоров)
- Редактирование
- Деактивация/активация
- Удаление (СПА комплексы остаются)

#### Пользователи (`/adminko/users`)
**Функционал:**
- Список всех пользователей
- Создание пользователя
- Редактирование:
  - Имя
  - Телефон
  - Роль (admin/vendor/user)
  - **Активация вендора** (переключатель `active`)
- Отображение статуса:
  - Вендор активен / На модерации
  - Остальные: Активен

#### Лиды (`/adminko/leads`)
- Список всех заявок
- Фильтр по СПА
- Фильтр по статусу
- Просмотр деталей

#### Справочники
- **Страны** (`/adminko/countries`)
- **Города** (`/adminko/cities`)
- **Категории** (`/adminko/categories`)
- **Цели** (`/adminko/goals`)
- **Услуги** (`/adminko/services`)
- **Удобства** (`/adminko/amenities`)

---

## 🗄️ Структура базы данных

### Основные таблицы

#### `profiles`
```sql
id              UUID PRIMARY KEY (FK → auth.users.id)
name            TEXT
phone           TEXT
role            TEXT CHECK (role IN ('admin', 'vendor', 'user'))
active          BOOLEAN DEFAULT false  -- Для активации вендоров
created_at      TIMESTAMPTZ DEFAULT now()
updated_at      TIMESTAMPTZ DEFAULT now()
```

#### `brands`
```sql
id              UUID PRIMARY KEY DEFAULT gen_random_uuid()
name            TEXT NOT NULL
description     TEXT
logo            TEXT
owner_id        UUID (FK → profiles.id)  -- Владелец (вендор)
active          BOOLEAN DEFAULT true
created_at      TIMESTAMPTZ DEFAULT now()
updated_at      TIMESTAMPTZ DEFAULT now()
```

#### `spas`
```sql
id              UUID PRIMARY KEY
name            TEXT NOT NULL
description     TEXT
address         TEXT
country_id      UUID (FK → countries.id)
city_id         UUID (FK → cities.id)
brand_id        UUID (FK → brands.id)  -- Привязка к бренду
category_id     UUID (FK → categories.id)
price_min       INTEGER
price_max       INTEGER
rating          DECIMAL
active          BOOLEAN DEFAULT true
created_at      TIMESTAMPTZ
updated_at      TIMESTAMPTZ
```

#### `spa_amenities`
```sql
id              UUID PRIMARY KEY DEFAULT gen_random_uuid()
spa_id          UUID NOT NULL (FK → spas.id)
amenity_id      UUID NOT NULL (FK → amenities.id)
custom_description TEXT  -- Кастомное описание от вендора
created_at      TIMESTAMPTZ DEFAULT now()

UNIQUE(spa_id, amenity_id)
```

#### `leads`
```sql
id              UUID PRIMARY KEY
spa_id          UUID (FK → spas.id)
name            TEXT NOT NULL
phone           TEXT NOT NULL
email           TEXT
date            DATE
time            TEXT
guests          INTEGER
status          TEXT DEFAULT 'new'
created_at      TIMESTAMPTZ
```

### Справочные таблицы

- `countries` - страны
- `cities` - города (FK → countries)
- `categories` - категории СПА
- `goals` - цели посещения
- `services` - услуги
- `amenities` - удобства

---

## 🔐 Row Level Security (RLS)

### profiles
- **SELECT:** Все могут читать все профили
- **INSERT:** Только при создании своего профиля
- **UPDATE:** Только свой профиль или админ

### brands
- **SELECT:** Все могут читать активные
- **INSERT:** Только admin
- **UPDATE:** Только admin или owner_id
- **DELETE:** Только admin

### spas
- **SELECT:** Все могут читать активные
- **INSERT:** Admin или вендор (owner через brand)
- **UPDATE:** Admin или вендор-владелец
- **DELETE:** Admin

### spa_amenities
- **SELECT:** Все
- **INSERT:** Admin или вендор-владелец СПА
- **UPDATE:** Admin или вендор-владелец СПА
- **DELETE:** Admin или вендор-владелец СПА

### leads
- **SELECT:** 
  - User видит только свои
  - Vendor видит заявки на свои СПА
  - Admin видит все
- **INSERT:** Любой авторизованный
- **UPDATE:** Только admin и vendor (свои СПА)

---

## 🛣️ Маршруты приложения

### Публичные
```
/                           - Главная
/catalog                    - Каталог СПА
/catalog/:country           - Каталог по стране
/catalog/:country/:city     - Каталог по городу
/spa/:id                    - Детальная страница СПА
/business                   - Информация для бизнеса
/business/register          - Регистрация вендора
/business/login             - Вход вендора
/business/pending           - Страница модерации вендора
/contacts                   - Контакты
/offer                      - Публичная оферта
```

### Авторизация
```
/user-auth                  - Вход/регистрация клиента
/profile                    - Профиль пользователя
```

### Админка (защищено)
```
/adminko                    - СПА комплексы
/adminko/leads              - Лиды
/adminko/brands             - Бренды
/adminko/users              - Пользователи
/adminko/countries          - Страны
/adminko/countries/:id      - Редактирование страны
/adminko/cities             - Города
/adminko/categories         - Категории
/adminko/goals              - Цели
/adminko/services           - Услуги
/adminko/amenities          - Удобства
```

---

## 🎨 UI Компоненты

### Основные компоненты из shadcn/ui:
- Button, Input, Label
- Card, Dialog, Alert
- Table, Badge, Switch
- Select, Textarea
- Tabs, Accordion

### Кастомные компоненты:
- `Layout` - общий layout с header/footer
- `AdminLayout` - layout админки с sidebar
- `ProtectedRoute` - защита роутов
- `SpaCard` - карточка СПА в каталоге
- Формы создания/редактирования

---

## 📊 Текущий статус реализации

### ✅ Реализовано

**Инфраструктура:**
- ✅ Настроен Supabase
- ✅ Настроен React + TypeScript + Vite
- ✅ Установлены shadcn/ui компоненты
- ✅ Настроен роутинг

**Авторизация:**
- ✅ AuthContext с ролями
- ✅ ProtectedRoute с проверкой ролей
- ✅ Вход/регистрация пользователей

**База данных:**
- ✅ Таблица profiles с полем active
- ✅ Таблица brands
- ✅ Таблица spa_amenities
- ✅ Таблица spas с brand_id
- ✅ Все справочники
- ✅ Таблица leads

**Публичная часть:**
- ✅ Главная страница
- ✅ Каталог СПА
- ✅ Страница детального просмотра СПА
- ✅ Форма заявки

**Для бизнеса:**
- ✅ Страница `/business`
- ✅ Регистрация вендора `/business/register`
- ✅ Вход вендора `/business/login`
- ✅ Страница модерации `/business/pending`

**Админка - Управление:**
- ✅ СПА комплексы (список, создание, редактирование)
- ✅ Бренды (CRUD, привязка к вендорам)
- ✅ Пользователи (CRUD, активация вендоров)
- ✅ Лиды (просмотр, фильтрация)

**Админка - Справочники:**
- ✅ Страны
- ✅ Города
- ✅ Категории
- ✅ Цели
- ✅ Услуги
- ✅ Удобства

### 🚧 В процессе / Требует доработки

**Критические проблемы:**
- 🔴 **КРИТИЧНО:** Медленная загрузка страниц (>10 секунд)
- 🔴 **КРИТИЧНО:** Запросы к profiles зависают
- 🟡 Нужны индексы БД для оптимизации
- 🟡 RLS политики могут быть причиной задержек

**Функционал:**
- ✅ AdminSpaEdit - добавить выбор бренда
- ✅ Личный кабинет вендора (отдельный от админки)
- ✅ Управление spa_amenities в интерфейсе
- ✅ Ограничение видимости для вендоров (только свои СПА)
- 🚧 Загрузка фото СПА

### 📝 TODO (Планируется)

**Приоритет 1 (Критично):**
1. Исправить производительность загрузки
2. Оптимизировать RLS политики
3. Добавить индексы в БД

**Приоритет 2 (Важно):**
1. ✅ Личный кабинет вендора (VendorDashboard)
2. ✅ Интерфейс управления удобствами СПА
3. ✅ Фильтрация СПА для вендора (только его бренд)
4. ✅ Выбор бренда при создании СПА

**Приоритет 3 (Желательно):**
1. Загрузка фото через Supabase Storage
2. Email уведомления о заявках
3. Статистика для вендора
4. Экспорт заявок в CSV

---

## 🔧 Сервисы и хуки

### Сервисы (`src/services/`)
- `brandService.ts` - CRUD для брендов
- `spaService.ts` - CRUD для СПА

### Хуки (`src/hooks/`)
- `useBrands.ts` - загрузка брендов
- `useCountries.ts` - загрузка стран

---

## 📁 Структура проекта

```
iwanna/
├── docs/                    # Документация
│   ├── prd.md              # Этот файл (Product Requirements)
│   ├── logs.md             # Журнал изменений
│   └── README.md           # Инструкции для разработчика
├── migrations/             # SQL миграции
├── src/
│   ├── components/         # React компоненты
│   ├── contexts/          # React contexts (Auth)
│   ├── hooks/             # Кастомные хуки
│   ├── lib/               # Утилиты (supabase client)
│   ├── services/          # Бизнес-логика
│   ├── types/             # TypeScript типы
│   └── App.tsx            # Главный компонент
├── supabase/              # Конфигурация Supabase
└── package.json
```

---

## 🔄 Правила обновления документации

**ВАЖНО:** Этот документ является **единым источником правды** о проекте.

### При любом изменении функционала:
1. ✅ Обновить соответствующий раздел в PRD
2. ✅ Добавить запись в `docs/logs.md`
3. ✅ Обновить статус реализации
4. ✅ Закоммитить изменения с описанием

### Формат обновления:
```markdown
**[Дата]** - Описание изменения
- Обновлен раздел: [название раздела]
- Причина: [почему было изменено]
```

---

## 📞 Контакты и поддержка

**Проект:** Iwanna  
**Разработчик:** [Указать контакты]  
**Supabase Project ID:** ewkeuupfristqqonkcph  
**База данных:** PostgreSQL через Supabase

---

*Последнее обновление: 03.10.2025*
